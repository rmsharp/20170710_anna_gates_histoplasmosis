---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(rmsutilityr, quietly = TRUE)
library(grid, quietly = TRUE)
library(animalr, quietly = TRUE)
library(xtable, quietly = TRUE)
library(RODBC, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(reshape2, quietly = TRUE)
library(lubridate, quietly = TRUE)
library(stringi, quietly = TRUE)
suppressPackageStartupMessages(library(XLConnect, quietly = TRUE))

library(histoplasmosisr, quietly = TRUE)

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r get-list-of-affected-animals}
filename <- "../inst/extdata/Copy of Histo Boon Sharp 20140716.xls"
histo_data <- loadWorkbook(filename)
arc_species_code = 'PC'
conn <- odbcConnect("frogstar-vortex-animal-sa")
original_df <- get_affected_animals_df(conn, histo_data, arc_species_code)
exp_df <- original_df

```
This next section gets age and sex matched controls.
```{r get-age-sex-matched-controls}
ctrl_df <- get_ctrl_df(conn, exp_df, arc_species_code)

## This next line is needed if controls are not found for all animals 
exp_df <- exp_df[exp_df$id %in% ctrl_df$match_id, ]
exp_df <- add_match_id(ctrl_df, exp_df)

```
This section looks up the location of each affected animal and its control
for each day of life prior to the diagnosis date and classifies it according
to one of the `r length(get_housing_types(conn))` housing types 
(`r get_and_or_list(names(get_housing_types(conn)))`).
```{r add-historical-housing-types}
X_exp <- "X_exp"
X_ctrl <- "X_ctrl"
housing_types <- get_housing_types(conn)
daily_exp_df <- make_daily_location(conn, X_exp, exp_df, housing_types)
daily_ctrl_df <- make_daily_location(conn, X_ctrl, ctrl_df, housing_types)
threshold_min_percent <- 0

```
The code below uses the daily housing type data to calculate the percent of
life spent in each housing type. Animals must have at least 
`r threshold_min_percent` of their housing history on record to be included in 
the study.
```{r calculate-housing-type-percents}
exp_housing_df <- add_location_type_percents(exp_df, daily_exp_df, 
                                     threshold_min_percent)
ctrl_housing_df <- add_location_type_percents(ctrl_df, daily_ctrl_df, 
                                      threshold_min_percent)

#merged_df <- merge(daily_df, df, by = "id")
exp_df_to_be_melted <- subset(exp_housing_df, select = c("id", "age", "sex", "days_gang", 
                                         "days_corral", "days_single"))
melt_exp_df <- melt(exp_df_to_be_melted, id = c("id", "sex", "age"))
ctrl_df_to_be_melted <- subset(ctrl_housing_df, select = c("id", "age", "sex", "days_gang", 
                                         "days_corral", "days_single"))
melt_ctrl_df <- melt(ctrl_df_to_be_melted, id = c("id", "sex", "age"))


percent_exp_animals_ever_in_corral <- 
  100.0 * length(melt_exp_df$value[melt_exp_df$value > 0 & 
                         melt_exp_df$variable == 'days_corral']) / 
  length(melt_exp_df$value[melt_exp_df$variable == 'days_corral'])
percent_exp_animals_ever_in_gang <- 
  100.0 * length(melt_exp_df$value[melt_exp_df$value > 0 & 
                         melt_exp_df$variable == 'days_gang']) / 
  length(melt_exp_df$value[melt_exp_df$variable == 'days_gang'])
percent_exp_animals_ever_single <-
  100.0 * length(melt_exp_df$value[melt_exp_df$value > 0 & 
                         melt_exp_df$variable == 'days_single']) / 
  length(melt_exp_df$value[melt_exp_df$variable == 'days_single'])

percent_ctrl_animals_ever_in_corral <- 
  100.0 * length(melt_ctrl_df$value[melt_ctrl_df$value > 0 & 
                         melt_ctrl_df$variable == 'days_corral']) / 
  length(melt_ctrl_df$value[melt_ctrl_df$variable == 'days_corral'])
percent_ctrl_animals_ever_in_gang <- 
  100.0 * length(melt_ctrl_df$value[melt_ctrl_df$value > 0 & 
                         melt_ctrl_df$variable == 'days_gang']) / 
  length(melt_ctrl_df$value[melt_ctrl_df$variable == 'days_gang'])
percent_ctrl_animals_ever_single <-
  100.0 * length(melt_ctrl_df$value[melt_ctrl_df$value > 0 & 
                         melt_ctrl_df$variable == 'days_single']) / 
  length(melt_ctrl_df$value[melt_ctrl_df$variable == 'days_single'])


```
One of the sources of histoplasmois infection is soil, which makes housing in 
the corral a potential risk factor. However, there were 
`r round(100.0 - percent_exp_animals_ever_in_corral, 0)` percent
of the affected animals that had never been in the corral.
```{r sample-housing-data}
library(knitr)
caption <- stri_c("Housing history for six of ", length(exp_df_to_be_melted), 
                  " affected animals.")
knitr::kable(exp_df_to_be_melted[1:6, ], caption = caption)
caption <- stri_c("Housing history for six of ", length(exp_df_to_be_melted), 
                  " control animals.")
knitr::kable(ctrl_df_to_be_melted[1:6, ], caption = caption)

```
```{r get-housing-type-ratios}
exp_df <- get_housing_type_ratios(conn, exp_df, housing_types, arc_species_code)

```
The contrast we want to look at now is whether or not there is a sex 
difference among those animals being observed with histoplasmosis. 
There are a few issues that should be considered.

  1. There are not equal numbers of males and females.
  2. There are different proportions of males and females.
  3. It is not known if males and females are examined at the same rate.
  
  The following analysis counts all of the males and females on each of the 
  dates on which an animal was diagnosed to have histoplasmosis.

```{r get-male-female-ratios}

exp_df <- get_male_female_ratio(conn, exp_df, arc_species_code)

affected_males <- length(exp_df$sex[exp_df$sex == 'M'])
affected_females <- length(exp_df$sex[exp_df$sex == 'F'])

total_males <- sum(exp_df$males)
total_females <- sum(exp_df$females)

```
```{r simple-chisquare-analysis-of-sex-ratio}
sex_exp_vs_total_m <- matrix(c(affected_females,
                        total_females,
                        affected_males,
                        total_males), nrow = 2)
sex_exp_vs_total_chisq <- chisq.test(x = sex_exp_vs_total_m)
sex_exp_vs_total_m
sex_exp_vs_total_chisq

```
```{r monti-carlo-simulation-analysis}

stat_f <- get_stat_f("sex") # Returns a function that calculates the frequency 
                            # of males
sex_mce <- get_mce(c('M', 'F'), ntrials = 100000, exp_df$male_prob, 
                   length(exp_df$id[exp_df$sex == 'M']) / nrow(exp_df), stat_f)
sex_mce
alpha <- 0.01
sex_exp_vs_total_rr <- calc_relative_risk(sex_exp_vs_total_m, alpha = alpha)
sex_exp_vs_total_rr

```
The relative risk of a female versus a male of being diagnosed as having 
histoplasmosis is `r round(sex_exp_vs_total_rr$RR, 2)` with a 
`r round((1.0 - sex_exp_vs_total_rr$alpha) * 100.0, 0)` percent confidence of 
`r signif(sex_exp_vs_total_rr$lowervalue, 3)` -- 
`r signif(sex_exp_vs_total_rr$uppervalue, 3)`.

The next section of code will look for histoplasmosis in SqlMed data.

The initial search limited the search to where the _TEST_ID_ was 25 and
the _TEST_NAME_ was 
"WRIGHT STAIN:", however, it was discovered that in most cases the _TEST_ID_ was
398 and there is no _TEST_NAME_
```{r get-sqlmed-histoplasmosis}
sql_txt <- stri_c(
  "select obr.animal_id, cd.arc_species_code, obr.VERIFIED_DATE_TM, 
    obr.REQUESTED_DATE_TM, 
     obr.OBSERVATION_DATE_TM,
     obx.TEST_ID, obx.TEST_NAME, obx.OBSERVED_VALUE, 'FINAL' as RESULT_STATUS
  from CLINICAL_PATH_OBR obr
  inner join CLINICAL_PATH_OBX obx on obr.MESSAGE_ID = obx.MESSAGE_ID
	  and obx.OBSERVED_VALUE like '%POSITIVE FOR H. CAP.VAR. DUBOISII%'
	  and obx.RESULT_STATUS = 'F'
  inner join current_data cd on obr.animal_id = cd.id
  order by cd.arc_species_code, obr.OBSERVATION_DATE_TM, obr.VERIFIED_DATE_TM,
    obr.REQUESTED_DATE_TM")
sqlmed_df <- sqlQuery(conn, sql_txt, stringsAsFactors = FALSE)

sqlmed_excel <- get_dated_excel_name("SqlMed_POSITIVE_FOR_H_CAP_VAR_DUBOISII")
create_wkbk(file = stri_c("../reports/", sqlmed_excel), 
            list(sqlmed_df), sheetnames = "histoplasmosis")


```
Of the `r length(unique(sqlmed_df$animal_id))` animals that were found to be
positive for _POSITIVE FOR H. CAP.VAR. DUBOISII_,
`r length(unique(sqlmed_df$animal_id[sqlmed_df$arc_species_code == "PC"]))` are 
baboons.


The next section will look for references to histoplasmosis within the clinical
animal records.
```{r get-clinical-history-references-to-histoplasmosis}
existing_clinical_sql <- stri_c(
  "select cd.arc_species_code, cp.id, cp.proc_date, cp.seq_num, 
  	cp.clinical_procedure, cp.user_name, cp.entry_date_tm
  from clinical_procedures cp
  inner join current_data cd on cp.id = cd.id
  where cp.clinical_procedure like '%histoplas%'
  order by cd.arc_species_code, cp.id, cp.proc_date, cp.seq_num")
existing_clinical_df <- sqlQuery(conn, existing_clinical_sql, 
                                 stringsAsFactors = FALSE)
existing_excel <- get_dated_excel_name("references to histoplas")
create_wkbk(file = stri_c("../reports/", existing_excel), 
            list(existing_clinical_df), sheetnames = "histoplas")

```

These data are in an Excel workbook (_`r existing_excel`_).

The following section collects all of the clinical records in the _animal_ 
database for all of the animals in the list provided by Ed Dick.

```{r get-clinical-records-of-affected}
id_str <- vector2string(unique(exp_df$id), SS = "', '")
affected_clinic_sql <- stri_c(
  "select cd.arc_species_code, cp.id, cp.proc_date, cp.seq_num, 
  	cp.clinical_procedure, cp.user_name, cp.entry_date_tm
  from clinical_procedures cp
  inner join current_data cd on cp.id = cd.id
  where cp.id in ('", id_str, "')
  order by cd.arc_species_code, cp.id, cp.proc_date, cp.seq_num")

affected_clinic_df <- sqlQuery(conn, affected_clinic_sql, 
                               stringsAsFactors = FALSE)
affected_clinic <- get_dated_excel_name("clinical_records_of_affecteds")
create_wkbk(file = stri_c("../reports/", affected_clinic), 
            list(affected_clinic_df), sheetnames = "affected")

```
There were `r nrow(affected_clinic_df)` clinical records found for 
`r length(unique(affected_clinic_df$id))` affected animals. 
The affected animal without clinical records is 
`r exp_df$id[!exp_df$id %in% affected_clinic_df$id]`.
They are recorded within the Excel workbook named _`r affected_clinic`_.

```{r close-database-connection}
odbcClose(conn)

```


